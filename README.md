# 低成本AI文字冒险游戏引擎

一个基于AI的沉浸式文字冒险游戏引擎，使用Python开发，支持中文交互，具备完整的角色扮演游戏机制。

## 🎮 项目特色

### 细节更新见更新日志

### 核心功能
- **低廉价格AI驱动叙事**: 使用AI生成动态剧情和选项，平均每轮成本不到1分钱(在100轮时的测试)
- **多样化的选项系统**:普通、检定、门槛三种选项，增加游戏丰富度
- **中文优化**: 专门为中文用户设计的提示词和交互界面
- **角色属性系统**: 六维主角属性，且可变动成长
- **道具管理系统**: 完整的背包系统，支持道具获取、使用和丢弃
- **概率检定机制**: 基于属性的成功概率计算和可视化动画
- **自动存档系统**: 每回合自动保存，支持手动存档/读档
- **API支持**: 兼容OpenAI API

### ▲成本低廉：

- 经过测试统计，百轮消耗总token 37W左右，且集合曲线斜率逐渐下降，证明在中小轮数下有较好的压缩，成本控制优秀

1-10轮:  平均token消耗: 2766.90  拟合直线: y = 27.1818x + 2617.4000

1-20轮:  平均token消耗: 2880.55  拟合直线: y = 22.0609x + 2648.9105

1-30轮:  平均token消耗: 3028.40  拟合直线: y = 27.0131x + 2609.6966

1-40轮:  平均token消耗: 3113.68  拟合直线: y = 21.6800x + 2669.2346 

1-50轮:  平均token消耗: 3231.78  拟合直线: y = 22.6622x + 2653.8931

1-60轮:  平均token消耗: 3331.10  拟合直线: y = 21.5156x + 2674.8729 

1-70轮:  平均token消耗: 3404.89  拟合直线: y = 18.9589x + 2731.8447

1-80轮:  平均token消耗: 3489.74  拟合直线: y = 18.3545x + 2746.3797

1-90轮:  平均token消耗: 3594.18  拟合直线: y = 19.1112x + 2724.6160  

1-100轮:  平均token消耗: 3687.30  拟合直线: y = 18.9110x + 2732.2939 

### 技术亮点

- **模块化架构**: 清晰的代码分离，易于扩展和维护
- **JSON配置驱动**: 所有设置通过配置文件管理，无需修改代码
- **动画效果**: 加载动画、打字机效果、概率检定动画
- **Token统计**: 实时监控API使用情况，优化成本控制
- **历史压缩**: 自动管理游戏历史，防止上下文过长

## 🚀 快速开始

### 环境要求
- Python 3.7+
- 依赖包：`openai`, `json_repair`

### 安装步骤

1. **克隆项目**
```bash
git clone <repository-url>
cd AI-game-test
```

2. **安装依赖**
```bash
pip install openai json_repair
```

3. **配置API密钥**
编辑 `apikeys.json` 文件，添加您的API密钥：
```json
{
  "api_keys": {
    "0": { "key": "your-api-key-here", "display_name": "提供商名称" }
  }
}
```

4. **配置模型和端点**
编辑 `models.json` 和 `baseurls.json` 文件，配置您要使用的模型和API端点。

5. **运行游戏**
```bash
python main.py
```

## ⚙️ 配置说明

### 主要配置文件

- **config.json**: 核心游戏设置
  - AI参数（max_tokens, temperature等）
  - 玩家偏好设置（色情、暴力、血腥、恐怖程度）
  - 玩家信息（姓名、背景故事）

- **models.json**: AI模型配置
- **baseurls.json**: API端点配置
- **apikeys.json**: 认证密钥配置

### 游戏设置

游戏启动后，您可以通过以下方式配置：
1. 首次运行时会进入配置界面
2. 游戏中输入 `config` 命令重新配置
3. 直接编辑JSON配置文件

## 🎯 游戏玩法

### 基本操作

1. **开始游戏**: 运行程序后，根据提示配置角色属性
2. **选择选项**: 输入数字选择剧情选项（1-6）
3. **查看状态**: 使用命令查看游戏状态
4. **保存进度**: 游戏自动保存，也可手动保存

### 可用命令

| 命令 | 功能 | 说明 |
|------|------|------|
| `exit` | 退出游戏 |  |
| `inv` | 查看道具 | 显示当前拥有的所有道具 |
| `attr` | 显示属性 | 查看角色六维属性 |
| `summary` | 查看历史摘要 |  |
| `save` | 手动保存 | （每轮自动存档，自动存档只保留最近10轮）、手动永久保存 |
| `load` | 读取 | （游戏会在启动时自动读取自动存档） |
| `new` | 新游戏 | 重新开始新游戏 |
| `config` | 配置游戏 |  |
| `custom` | 自定义行动 | 当不采用AI生成的选项时，可输入自定义的行动描述 |
| `add_item` | 添加道具 | 手动添加道具（调试用） |
| `remove_item` | 丢弃道具 | 手动移除道具 |
| `ana_token` | Token统计 | 查看API使用统计 |
| `help` | 显示帮助 |  |
| `show_init_resp` | 切换显示AI原始回复和token详细信息 | 可切换开关，调试用 |

### 游戏机制

#### 属性系统
- 力、敏、智、感、魅、运共六维属性

#### 概率检定
- **普通选项**: 直接执行
- **检定选项**: 基于属性和随机值进行判定是否成功
- **门槛选项**: 需要达到属性门槛才能选择

#### 形势值
- 范围：-10（绝对劣势）到 10（绝对优势）
- 影响检定成功率和剧情发展
- 根据剧情事件动态变化

## 📁 项目结构

```
AI-game-test/
├── main.py              # 主程序入口，游戏循环和UI
├── game_engine.py       # 游戏引擎核心逻辑
├── config.py            # 配置管理系统
├── prompt_manager.py    # 提示词管理
├── animes.py            # 动画效果工具
├── config.json          # 游戏设置
├── models.json          # AI模型配置
├── baseurls.json        # API端点配置
├── apikeys.json         # API密钥配置
├── 开局.txt             # 示例游戏剧本
├── saves/               # 存档目录
├── logs/                # 游戏日志
└── __pycache__/         # Python缓存
```

## 🔧 开发指南

### 扩展新功能

1. **添加新命令**: 在 `main.py` 的 `get_user_input_and_go` 函数中添加命令处理
2. **修改游戏机制**: 编辑 `game_engine.py` 中的相关方法
3. **自定义提示词**: 修改 `prompt_manager.py` 中的提示词模板

### API响应格式

AI响应必须遵循以下JSON格式：
```json
{
  "description": "场景描述",
  "summary": "10-25字摘要",
  "options": [
    {
      "id": 1,
      "text": "选项文本",
      "type": "normal|check|must",
      "main_factor": "属性名",  (normal无) 
      "difficulty": 数值,       (normal无)
      "base_probability": 概率, (normal\must无)
      "next_preview": "预览文本"
    }
  ],
  "commands": [
    {
      "command": "add_item|remove_item|change_attribute|change_situation_value|gameover",
      "value": "指令值"
    }
  ]
}
```

## 🎨 视觉效果

- **颜色编码**: 不同游戏元素使用不同颜色
  - 红色: 危险/失败
  - 绿色: 成功/增益
  - 黄色: 警告/中性
  - 蓝色: 信息/属性

- **动画效果**:
  - 加载动画（旋转、点状、进度条）
  - 打字机效果的文字输出
  - 概率检定的可视化动画

## 📊 性能优化

### Token管理
- 实时显示Token使用统计
- 自动压缩历史记录防止上下文过长
- 支持Token消耗分析功能

### 存档优化
- 自动存档管理（保留最近10个存档）
- 游戏ID标识，支持多游戏并行
- 存档文件包含完整游戏状态

## 🐛 故障排除

### 常见问题

1. **API连接失败**
   - 检查 `apikeys.json` 中的密钥是否正确
   - 验证 `baseurls.json` 中的端点是否可访问

2. **JSON解析错误**
   - AI响应格式不符合要求
   - 检查提示词模板是否完整

3. **游戏无法保存**
   - 检查 `saves/` 目录权限
   - 确认磁盘空间充足

### 调试命令

游戏内置调试命令：
- `show_init_resp`: 显示AI原始响应
- `fix_item_name`: 修复道具名错误
- `ana_token`: 分析Token使用模式

## 🤝 贡献指南

欢迎提交Issue和Pull Request来改进项目！

### 开发规范
- 遵循现有代码风格
- 添加适当的注释
- 测试新功能确保兼容性

## 📄 许可证

本项目采用MIT许可证，详见LICENSE文件。

## 🙏 致谢

感谢所有AI模型提供商的支持，以及开源社区的贡献。

---

**开始您的AI文字冒险之旅吧！** 🎮✨